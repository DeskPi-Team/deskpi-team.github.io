<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://wiki.deskpi.com/super4c/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>DeskPi Super4C - DeskPi Products Wiki</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "DeskPi Super4C";
        var mkdocs_page_input_path = "super4c.md";
        var mkdocs_page_url = "/super4c/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> DeskPi Products Wiki
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../deskpilite_pi5_case/">DeskPi Lite Pi5 Case</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rackmate_t0/">DeskPi RackMate T0</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rackmate/">DeskPi RackMate T1</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rackmate_accessories_allinone/">DeskPi RackMate Accessories</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../microcar/">DeskPi MicroCar</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../deskpi_lite_nas_case/">DeskPi Lite NAS Case</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../expansionkit/">DeskPi Lite Expansion Kit</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../deskpi_lite_for_3b/">DeskPi Lite For Raspberry Pi 3B/3B+</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../minipc/">DeskPi Mini PC</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../picomate/">DeskPi PicoMate</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">DeskPi Super4C</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#features">Features</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#main-power-input">Main Power Input</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#main-power-protection">Main Power Protection</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#internal-5v-dcdc-and-buttons">Internal 5V DC/DC and Buttons</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#voltage-and-current-monitoring">Voltage and Current Monitoring</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cm5-modules">CM5 Modules</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cm5-connector">CM5 Connector</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#micro-hdmi-20-interface">micro HDMI 2.0 Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usb30-interface">USB3.0 Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usb20-interface">USB2.0 Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#1gbps-ethernet-interface">1Gbps Ethernet Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#25gbps-ethernet-interface">2.5Gbps Ethernet Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#microsd-card-interface">microSD Card Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#m2-m-key-interface">M.2 M-Key Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#fan-interface">Fan Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rtc-battery-interface">RTC Battery Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mipi-interface">MIPI Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#jumper-headers">Jumper Headers</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#esp32">ESP32</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#esp32-pin-allocation">ESP32 Pin Allocation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#esp32-buttons">ESP32 Buttons</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#esp32-i2c-address">ESP32 I2C Address</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#esp32-firmware">ESP32 Firmware</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#open-source">Open Source</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#flash-an-image-to-a-compute-module">Flash an image to a Compute Module</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#prerequisites">Prerequisites</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#set-up-the-io-board">Set up the IO Board</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#set-up-the-host-device">Set up the host device</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#flash-the-emmc">Flash the eMMC</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#boot-from-emmc">Boot from eMMC</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#more-information-please-visit">More information please visit:</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#application-demo">Application Demo</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#0-hardware-network-topology">0. Hardware &amp; Network Topology</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#1-prepare-the-control-node-only-this-machine">1. Prepare the Control Node (ONLY this machine)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#inventory-first-time-ssh-setup">Inventory &amp; First-Time SSH Setup</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#create-playbooksinit-sshyml-file">Create playbooks/init-ssh.yml file</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#run-once">Run once:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#basic-system-initialization">Basic System Initialization</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#create-rolescommontasksmainyml">Create roles/common/tasks/main.yml</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#create-python-virtualenv-install-data-science-packages">Create Python Virtualenv &amp; Install Data-Science Packages</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#gather-hostname-ip-disk-information">Gather Hostname, IP, Disk Information</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#batch-shutdown-reboot">Batch Shutdown / Reboot</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#get-the-cpu-temperature">Get the CPU temperature</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#quick-reference">Quick Reference</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../super6c/">DeskPi Super6C</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../itxcase/">DeskPi ITX Case Kit for Super6C</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../deskpilite/">DeskPi Lite</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../deskpinano/">DeskPi Nano</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../deskpipro/">DeskPi Pro</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">DeskPi Products Wiki</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>DeskPi Super4C</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="super4c">Super4C</h1>
<h2 id="introduction">Introduction</h2>
<p>The Super4C is a cluster - type hardware built on the Raspberry Pi CM5.
It supports four channels of CM5 and extends almost all the interfaces of CM5, providing users with powerful device - connection capabilities. Meanwhile, the hardware also integrates an ESP32 processing module, which offers remote management capabilities for the entire cluster of devices. For the sake of convenience in explanation, this document will refer to this cluster board hardware as the "motherboard" in the following sections.</p>
<p><font color=red> Compatible with Raspberry Pi CM5 Only</font><br> </p>
<p><img alt="super4c01" src="../imgs/super4c/main_01.png" /> </p>
<h2 id="features">Features</h2>
<ul>
<li>Standard mini ITX form factor</li>
<li>Supports all Raspberry Pi CM5 modules</li>
<li>External DC 19V/4.73A power input with redundant interface support and reverse polarity protection</li>
<li>Four-channel independent DC/DC conversion to provide power for:</li>
<li>Independent power reset button (simultaneously resets CM5, NVMe, 2.5Gbps, 1Gbps, SD card, CAM0/1, etc.)</li>
<li>Hardware power - on delay (approximately 0.5 seconds each) to avoid inrush current from simultaneous power on</li>
<li>4 - pin fan connector (directly connected to the DC 19V power port)</li>
<li>Supports up to four CM5 modules per channel, each with:</li>
<li>1x micro HDMI interface</li>
<li>1x USB 3.0 interface</li>
<li>1x USB 2.0 interface (Type - C connector, no VBUS output)</li>
<li>1x 1Gbps Ethernet interface</li>
<li>1x 2.5Gbps Ethernet interface (via USB 3.0 expansion)</li>
<li>1x microSD card interface</li>
<li>1x M.2 M - key PCIe interface</li>
<li>1x 4 - pin JST - SH PWM fan interface</li>
<li>1x RTC battery interface</li>
<li>2x MIPI DSI/CSI - 2 interfaces</li>
<li>Jumper interface (to disable eMMC, EEPROM, etc.)</li>
<li>Integrated ESP32 - WROOM - 32E - N4 module</li>
<li>Supports 2.4GHz Wi - Fi + Bluetooth with integrated antenna</li>
<li>Expanded W5500 100Mbps wired network</li>
<li>4 - pin UART download interface</li>
<li>4 - pin I2C expansion interface (for expanding OLED screens, etc.)</li>
<li>Two integrated INA3221 chips for measuring voltage and current of six channels on the board</li>
<li>ESP32 pins can individually control the power switch for each channel and the PMIC_EN signal switch for CM5</li>
<li>BOOT/EN button</li>
</ul>
<h3 id="main-power-input">Main Power Input</h3>
<p>The main power input uses a barrel power connector (inner diameter 2mm, outer diameter 6.6mm) with a voltage range of DC 19V. 
Two connectors (DC1, DC2) support redundant power input. When two power supplies with different voltages are inserted simultaneously, the hardware will automatically select the power supply with the higher voltage.</p>
<p><img alt="super4c02" src="../imgs/super4c/main_02.png" /> </p>
<h3 id="main-power-protection">Main Power Protection</h3>
<p>The main power supply passes through the protection circuit, voltage and current sampling circuit, reverse polarity protection circuit, and fuse circuit before providing power to the internal components and simultaneously outputting to the J15 connector for powering the external main fan. <strong>Note</strong>: When connecting a fan, ensure that the fan's rated voltage matches the main power supply voltage.</p>
<h3 id="internal-5v-dcdc-and-buttons">Internal 5V DC/DC and Buttons</h3>
<p>The main power supply passes through the internal four - channel DC/DC circuit, converting it into a 5V power supply for each CM5 module and its peripherals. Each DC/DC channel has an independent power reset button (PWR_OFF1/2/3/4). Pressing the button (SW3/4/5/6) will reset the power supply for each CM5 module and its peripheral channel individually.</p>
<p><img alt="super4c03" src="../imgs/super4c/main_03.png" /> </p>
<h3 id="voltage-and-current-monitoring">Voltage and Current Monitoring</h3>
<p>Both the main power sockets and the four internal 5V power rails are equipped with voltage and current sensing capabilities. Through the I2C interface of the ESP32, two INA3221 chips (covering a total of six channels) are controlled to monitor voltage and current.</p>
<p><img alt="super4c04" src="../imgs/super4c/main_04.png" /> </p>
<h3 id="cm5-modules">CM5 Modules</h3>
<p>A total of four CM5 channels are supported, with each channel featuring identical extended interfaces, which are labeled with the numbers 1, 2, 3, and 4 on the hardware silk screen.</p>
<h3 id="cm5-connector">CM5 Connector</h3>
<p>The standard CM5 connector is used, with a total height of 3mm below the board after installation.</p>
<h3 id="micro-hdmi-20-interface">micro HDMI 2.0 Interface</h3>
<p>The standard micro HDMI interface is directly connected to the HDMI0 interface of the CM5 module. The 5V power on the interface is provided by the motherboard through a current - limiting switch.</p>
<h3 id="usb30-interface">USB3.0 Interface</h3>
<p>The CM5 module features two USB 3.0 interfaces. On this motherboard, the USB 3.0 interface is connected to Port 0. The interface is equipped with a current - limiting switch, which provides a maximum power supply capability of 0.9A to external devices.</p>
<p><img alt="super4c05" src="../imgs/super4c/main_05.png" /> </p>
<h3 id="usb20-interface">USB2.0 Interface</h3>
<p>The CM5 module has one USB 2.0 interface, which is connected to the Type-C connector on this motherboard. This interface only connects the D+/D- signals and does not provide power to external devices. It can be used in conjunction with the nRPIBOOT signal to program the CM5.</p>
<p><img alt="super4c06" src="../imgs/super4c/main_06.png" /> </p>
<h3 id="1gbps-ethernet-interface">1Gbps Ethernet Interface</h3>
<p>Connected to the native Gigabit Ethernet interface of the CM5, it uses a standard RJ45 connector and does not support Power over Ethernet (PoE).</p>
<p><img alt="super4c07" src="../imgs/super4c/main_07.png" /> </p>
<h3 id="25gbps-ethernet-interface">2.5Gbps Ethernet Interface</h3>
<p>The CM5 module features two USB 3.0 interfaces. On this motherboard, the 2.5Gbps Ethernet interface is expanded through the USB 3.0 Port 1 of the CM5. This interface also supports Gigabit and Fast Ethernet (100Mbps) connections.</p>
<p><img alt="super4c08" src="../imgs/super4c/main_08.png" /> </p>
<h3 id="microsd-card-interface">microSD Card Interface</h3>
<p>A push - type interface that only supports the CM5Lite version.</p>
<h3 id="m2-m-key-interface">M.2 M-Key Interface</h3>
<p>Supports various M.2 M-key cards. The interface only provides PCIe signals and supports the 2280 form factor.</p>
<h3 id="fan-interface">Fan Interface</h3>
<p>The interface size and signal definitions are the same as those on the official CM5 IO board.</p>
<p><img alt="super4c09" src="../imgs/super4c/main_09.png" /> </p>
<h3 id="rtc-battery-interface">RTC Battery Interface</h3>
<p>The interface size and signal definitions are the same as those on the official CM5 IO board</p>
<p><img alt="super4c10" src="../imgs/super4c/main_10.png" /> </p>
<h3 id="mipi-interface">MIPI Interface</h3>
<p>The interface size and signal definitions are the same as those on the official CM5 IO board, featuring a 22 - pin, 0.5 - pitch FPC (Flexible Printed Circuit) connector.</p>
<p><img alt="super4c11" src="../imgs/super4c/main_11.png" /> </p>
<h3 id="jumper-headers">Jumper Headers</h3>
<p>The IO voltage is by default configured to +3.3V. The pin definitions correspond one - to - one with the silk - screen markings on the board. These headers also bring out GPIO8/9/10/11 for expansion use. Additionally, the PMIC_ENABLE signal can be controlled either through jumpers or via the ESP32 (with different ESP32 IO pins allocated for controlling different CM5 channels). The figure below shows the jumper pins and silk - screen markings corresponding to the first - channel CM5.</p>
<p><img alt="super4c12" src="../imgs/super4c/main_12.png" /> </p>
<h3 id="esp32">ESP32</h3>
<p>The model of the ESP32 integrated on the motherboard is ESP32-WROOM-32E-N4. The motherboard comes with a pre-installed basic firmware that can perform simple power control, monitor voltage and current, and display the information in real - time on an OLED screen (SSD1306).</p>
<h4 id="esp32-pin-allocation">ESP32 Pin Allocation</h4>
<table>
<thead>
<tr>
<th><strong>Pin</strong></th>
<th><strong>ESP32-WROOM-32E</strong></th>
<th><strong>Super4C Net Name</strong></th>
<th><strong>Function / Notes</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>GND</td>
<td>GND</td>
<td><strong>Ground</strong></td>
</tr>
<tr>
<td>2</td>
<td>3V3</td>
<td>3V3</td>
<td><strong>3.3 V Power Supply</strong></td>
</tr>
<tr>
<td>3</td>
<td>EN</td>
<td>EN</td>
<td><strong>HIGH=ON</strong> (ESP32 enabled)<br><strong>LOW=OFF</strong> (ESP32 shut-down)<br>Also wired to <strong>SW2</strong> (pressed = LOW)</td>
</tr>
<tr>
<td>4</td>
<td>SENSOR_VP</td>
<td>NC</td>
<td><em>Unconnected</em></td>
</tr>
<tr>
<td>5</td>
<td>SENSOR_VN</td>
<td>NC</td>
<td><em>Unconnected</em></td>
</tr>
<tr>
<td>6</td>
<td>IO34</td>
<td>NC</td>
<td><em>Unconnected</em></td>
</tr>
<tr>
<td>7</td>
<td>IO35</td>
<td>NC</td>
<td><em>Unconnected</em></td>
</tr>
<tr>
<td>8</td>
<td>IO32</td>
<td>XTAL_32K_P</td>
<td>32.768 kHz crystal <strong>input</strong></td>
</tr>
<tr>
<td>9</td>
<td>IO33</td>
<td>XTAL_32K_N</td>
<td>32.768 kHz crystal <strong>output</strong></td>
</tr>
<tr>
<td>10</td>
<td>IO25</td>
<td>CM5_4_PMIC_ENABLE</td>
<td><strong>Channel-4 Enable</strong><br>HIGH=ON (default) ‑ LOW=OFF</td>
</tr>
<tr>
<td>11</td>
<td>IO26</td>
<td>CM5_3_PMIC_ENABLE</td>
<td><strong>Channel-3 Enable</strong><br>HIGH=ON (default) ‑ LOW=OFF</td>
</tr>
<tr>
<td>12</td>
<td>IO27</td>
<td>CM5_2_PMIC_ENABLE</td>
<td><strong>Channel-2 Enable</strong><br>HIGH=ON (default) ‑ LOW=OFF</td>
</tr>
<tr>
<td>13</td>
<td>IO14</td>
<td>CM5_1_PMIC_ENABLE</td>
<td><strong>Channel-1 Enable</strong><br>HIGH=ON (default) ‑ LOW=OFF</td>
</tr>
<tr>
<td>14</td>
<td>IO12</td>
<td>NC</td>
<td><em>Unconnected</em></td>
</tr>
<tr>
<td>15</td>
<td>GND</td>
<td>GND</td>
<td><strong>Ground</strong></td>
</tr>
<tr>
<td>16</td>
<td>IO13</td>
<td>BMC_I2C_SDA</td>
<td>I²C <strong>SDA</strong><br>→ two on-board <strong>INA3221</strong> + <strong>J12</strong> &amp; <strong>J6</strong></td>
</tr>
<tr>
<td>17-22</td>
<td>—</td>
<td>NC</td>
<td><em>Unconnected</em></td>
</tr>
<tr>
<td>23</td>
<td>IO15</td>
<td>BMC_I2C_SCL</td>
<td>I²C <strong>SCL</strong><br>→ two on-board <strong>INA3221</strong> + <strong>J12</strong> &amp; <strong>J6</strong></td>
</tr>
<tr>
<td>24</td>
<td>IO2</td>
<td>BMC_PSU1</td>
<td><strong>PSU-1 ENABLE</strong><br><code>HIGH=OFF</code> ‑ <code>LOW=ON</code> (default)</td>
</tr>
<tr>
<td>25</td>
<td>IO0</td>
<td>BOOT</td>
<td>Boot-strap (strapping) pin</td>
</tr>
<tr>
<td>26</td>
<td>IO4</td>
<td>BMC_PSU2</td>
<td><strong>PSU-2 ENABLE</strong><br><code>HIGH=OFF</code> ‑ <code>LOW=ON</code> (default)</td>
</tr>
<tr>
<td>27</td>
<td>IO16</td>
<td>BMC_PSU3</td>
<td><strong>PSU-3 ENABLE</strong><br><code>HIGH=OFF</code> ‑ <code>LOW=ON</code> (default)</td>
</tr>
<tr>
<td>28</td>
<td>IO17</td>
<td>BMC_PSU4</td>
<td><strong>PSU-4 ENABLE</strong><br><code>HIGH=OFF</code> ‑ <code>LOW=ON</code> (default)</td>
</tr>
<tr>
<td>29</td>
<td>IO5</td>
<td><code>#SCS_W5500</code></td>
<td>W5500 <strong>SPI-CS</strong> (pin 32)</td>
</tr>
<tr>
<td>30</td>
<td>IO18</td>
<td>SCLK_W5500</td>
<td>W5500 <strong>SPI-CLK</strong> (pin 33)</td>
</tr>
<tr>
<td>31</td>
<td>IO19</td>
<td>MISO_W5500</td>
<td>W5500 <strong>MISO</strong> (pin 34)</td>
</tr>
<tr>
<td>32</td>
<td>—</td>
<td>NC</td>
<td><em>Unconnected</em></td>
</tr>
<tr>
<td>33</td>
<td>IO21</td>
<td><code>#INT_W5500</code></td>
<td>W5500 <strong>INT</strong> (pin 36)</td>
</tr>
<tr>
<td>34</td>
<td>RXD0</td>
<td>BMC_RXD0</td>
<td>UART0 RX → <strong>J47</strong></td>
</tr>
<tr>
<td>35</td>
<td>TXD0</td>
<td>BMC_TXD0</td>
<td>UART0 TX → <strong>J47</strong></td>
</tr>
<tr>
<td>36</td>
<td>IO22</td>
<td><code>#RST_W5500</code></td>
<td>W5500 <strong>RST</strong> (pin 37)</td>
</tr>
<tr>
<td>37</td>
<td>IO23</td>
<td>MOSI_W5500</td>
<td>W5500 <strong>MOSI</strong> (pin 35)</td>
</tr>
<tr>
<td>38</td>
<td>GND</td>
<td>GND</td>
<td><strong>Ground</strong></td>
</tr>
</tbody>
</table>
<h4 id="esp32-buttons">ESP32 Buttons</h4>
<ul>
<li><strong>BOOT (SW1):</strong></li>
<li>When the BOOT button is held down while powering on the motherboard (or while powered on, hold both BOOT and EN buttons, release the EN button first, and then release the BOOT button), the ESP32 will enter programming mode. The ESP32 can then be programmed via the UART interface (J47).</li>
<li>
<p>In the default firmware, after the ESP32 starts up, the BOOT pin is used as an input IO (GPIO0). When the BOOT button is pressed for more than 1 second and then released, the ESP32 will sequentially disable the PMIC_ENABLE signals for the four CM5 modules and the ENABLE signals for the four DC/DC (5V) channels, with an interval of approximately 0.5 seconds.</p>
</li>
<li>
<p><strong>EN (SW2):</strong></p>
</li>
<li>In the default firmware, pressing the EN button will reset all CM5_PMIC_ENABLE and DC/DC (5V) ENABLE signals.</li>
</ul>
<h4 id="esp32-i2c-address">ESP32 I2C Address</h4>
<p>The I2C signals of the ESP32 are connected to both the J12 and J6 headers, as well as the two onboard INA3211 chips. The headers can be used to expand external I2C devices.</p>
<table>
<thead>
<tr>
<th><strong>Item</strong></th>
<th><strong>Channels / Pins / Address</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>J12 Connector</strong></td>
<td>4-pin 2.54 mm header (GND, 3V3, SDA, SCL)</td>
<td>Header for plugging in an <strong>OLED module</strong> (I²C interface)</td>
</tr>
<tr>
<td><strong>J16 Connector</strong></td>
<td>4-pin 2.54 mm header (GND, 3V3, SDA, SCL)</td>
<td>Header for <strong>additional I²C devices</strong></td>
</tr>
<tr>
<td><strong>INA3221 #1</strong></td>
<td>3-channel • 20 mΩ shunt • I²C address <code>0x40</code></td>
<td>IN1 → <strong>DC1</strong><br>IN2 → <strong>DC2</strong><br>IN3 → <strong>DC/DC 5 V #1</strong></td>
</tr>
<tr>
<td><strong>INA3221 #2</strong></td>
<td>3-channel • 20 mΩ shunt • I²C address <code>0x41</code></td>
<td>IN1 → <strong>DC/DC 5 V #2</strong><br>IN2 → <strong>DC/DC 5 V #3</strong><br>IN3 → <strong>DC/DC 5 V #4</strong></td>
</tr>
</tbody>
</table>
<p>The pinout diagram for J12/J6 connectors is as follows:</p>
<p><img alt="super4c13" src="../imgs/super4c/main_13.png" /> </p>
<h4 id="esp32-firmware">ESP32 Firmware</h4>
<p>The ESP32 comes with default firmware:</p>
<ul>
<li>It can control the DC/DC power supply for four channels and the PMIC_ENABLE signal for CM5.</li>
<li>It can drive the OLED display module (SSD1306).</li>
<li>It can monitor the current information of a total of six channels (two DC input ports and four internal 5V power supplies).</li>
<li>It can display the collected current information on the OLED screen all at once.</li>
<li>It can detect the network connectivity of W5500:</li>
<li>When connected, the OLED screen displays: 192.168.1.222</li>
<li>When not connected, the OLED screen displays: LINK: OFF</li>
</ul>
<h3 id="open-source">Open Source</h3>
<p>Some pages of the schematics and the ESP32 default firmware source code can be open - sourced to facilitate secondary development of the board by community enthusiasts.
It will be open source once the firmware has been test out. </p>
<h3 id="flash-an-image-to-a-compute-module">Flash an image to a Compute Module</h3>
<p>To flash the same image to multiple Compute Modules, use the Raspberry Pi Secure Boot Provisioner. To customise an OS image to flash onto those devices, use pi-gen.</p>
<p>The Compute Module has an on-board eMMC device connected to the primary SD card interface. This guide explains how to flash (write) an operating system image to the eMMC storage of a single Compute Module.
Lite variants of Compute Modules do not have on-board eMMC. Instead, follow the procedure to flash a storage device for other Raspberry Pi devices at Install an operating system.</p>
<h4 id="prerequisites">Prerequisites</h4>
<p>To flash the Compute Module eMMC, you need the following:
* Another computer, referred to in this guide as the host device. You can use Linux (we recommend Raspberry Pi OS or Ubuntu), Windows 11, or macOS.
*   Super4C mother board.
*   A USB-C cable for Compute Module models flashing image. </p>
<h4 id="set-up-the-io-board">Set up the IO Board</h4>
<ul>
<li>1.Connect the Compute Module to the Super4C board. When connected, the Compute Module should lie flat.</li>
<li>2.Fit <code>nRPI_BOOT</code> to <code>GND</code> Pin (disable eMMC Boot) on the board with jumper.</li>
</ul>
<p><img alt="super4c14" src="../imgs/super4c/main_14.png" /> </p>
<ul>
<li>Connect a cable from USB-C slave port J11 on the board to the host device.</li>
</ul>
<p><img alt="super4c15" src="../imgs/super4c/main_15.png" /> </p>
<h4 id="set-up-the-host-device">Set up the host device</h4>
<p>Next, let’s set up software on the host device.
For a host device, we recommend a Raspberry Pi 4 or newer running 64-bit Raspberry Pi OS.</p>
<h5 id="for-linux">For Linux:</h5>
<p>To set up software on a Linux host device:</p>
<ul>
<li>1.Run the following command to install rpiboot (or, alternatively, build rpiboot from source):</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>rpiboot
</span></code></pre></div>
<ul>
<li>2.Connect the IO Board to power.</li>
<li>3.Then, run rpiboot:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>sudo<span class="w"> </span>rpiboot
</span></code></pre></div></li>
<li>4.After a few seconds, the Compute Module should appear as a mass storage device. Check the /dev/ directory, likely /dev/sda or /dev/sdb, for the device. Alternatively, run lsblk and search for a device with a storage capacity that matches the capacity of your Compute Module.</li>
</ul>
<h5 id="for-macos">For macOS:</h5>
<p>To set up software on a macOS host device:</p>
<ul>
<li>1.First, build rpiboot from source.</li>
<li>2.Connect the IO Board to power.</li>
<li>3.Then, run the rpiboot executable with the following command:</li>
</ul>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>rpiboot<span class="w"> </span>-d<span class="w"> </span>mass-storage-gadget64
</span></code></pre></div>
* 4.When the command finishes running, you should see a message stating "The disk you inserted was not readable by this computer." Click Ignore. Your Compute Module should now appear as a mass storage device</p>
<h5 id="for-windows">For Windows:</h5>
<p>To set up software on a Windows 11 host device:</p>
<ul>
<li>1.Download the Windows installer or build rpiboot from source. 
Windows installer Download URL: https://github.com/raspberrypi/usbboot/raw/master/win32/rpiboot_setup.exe
Build source : https://github.com/raspberrypi/usbboot</li>
<li>2.Double-click on the installer to run it. This installs the drivers and boot tool. Do not close any driver installation windows which appear during the installation process.</li>
<li>3.Reboot</li>
<li>4.Connect the IO Board to power. Windows should discover the hardware and configure the required drivers.</li>
<li>5.On CM4 and later devices, select Raspberry Pi - Mass Storage Gadget - 64-bit from the start menu. After a few seconds, the Compute Module eMMC or NVMe will appear as USB mass storage devices. This also provides a debug console as a serial port gadget.</li>
<li>6.On CM3 and older devices, select rpiboot. Double-click on RPiBoot.exe to run it. After a few seconds, the Compute Module eMMC should appear as a USB mass storage device.</li>
</ul>
<h3 id="flash-the-emmc">Flash the eMMC</h3>
<p>You can use Raspberry Pi Imager to flash an operating system image to a Compute Module.  Raspberry Pi Imager Download URL: https://www.raspberrypi.com/documentation/computers/getting-started.html#raspberry-pi-imager
Alternatively, use dd to write a raw OS image (such as Raspberry Pi OS) to your Compute Module. Run the following command, replacing /dev/sdX with the path to the mass storage device representation of your Compute Module and raw_os_image.img with the path to your raw OS image:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>raw_os_image.img<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/sdX<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>4MiB
</span></code></pre></div>
<p>Once the image has been written, disconnect and reconnect the Compute Module. You should now see two partitions (for Raspberry Pi OS):</p>
<pre>
/dev/sdX    <- Device
/dev/sdX1   <- First partition (FAT)
/dev/sdX2   <- Second partition (Linux filesystem)
</pre>

<p>You can mount the /dev/sdX1 and /dev/sdX2 partitions normally.
For example: 
Following figure shows that how to dump the OS from Raspberry Pi’s MicroSD card to the CM5’s eMMC storage: </p>
<p><img alt="super4c16" src="../imgs/super4c/main_16.png" /> </p>
<h2 id="boot-from-emmc">Boot from eMMC</h2>
<p>Disconnect <code>nRPI_BOOT</code> from <code>GND</code> (disable eMMC Boot) on the super4c board jumper.</p>
<p>Disconnect the USB slave port. Power-cycle the super4c board to boot the Compute Module from the new image you just wrote to eMMC.</p>
<h2 id="more-information-please-visit">More information please visit:</h2>
<p><a href="https://www.raspberrypi.com/documentation/computers/compute-module.html">Raspberry Pi Official Documentations</a></p>
<h2 id="application-demo">Application Demo</h2>
<p>End-to-End Guide: Build &amp; Manage a 4-Node Raspberry Pi CM5 Cluster with Ansible on Raspberry Pi 5</p>
<blockquote>
<p>All previous Chinese instructions condensed, corrected, and translated into a single English document.</p>
</blockquote>
<hr />
<h2 id="0-hardware-network-topology">0. Hardware &amp; Network Topology</h2>
<table>
<thead>
<tr>
<th>Node</th>
<th>Role</th>
<th>IP Address</th>
</tr>
</thead>
<tbody>
<tr>
<td>Raspberry Pi 5</td>
<td><strong>Ansible Control Node</strong></td>
<td>192.168.10.1/24</td>
</tr>
<tr>
<td>CM5-01</td>
<td>Compute Module 5</td>
<td>192.168.10.11</td>
</tr>
<tr>
<td>CM5-02</td>
<td>Compute Module 5</td>
<td>192.168.10.12</td>
</tr>
<tr>
<td>CM5-03</td>
<td>Compute Module 5</td>
<td>192.168.10.13</td>
</tr>
<tr>
<td>CM5-04</td>
<td>Compute Module 5</td>
<td>192.168.10.14</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="1-prepare-the-control-node-only-this-machine">1. Prepare the Control Node (ONLY this machine)</h2>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>full-upgrade<span class="w"> </span>-y
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>python3-pip<span class="w"> </span>sshpass<span class="w"> </span>jq
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>pip3<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span>ansible-core<span class="o">==</span><span class="m">2</span>.16
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;export PATH=$PATH:~/.local/bin&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>~/.bashrc
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>~/cm5-cluster/<span class="o">{</span>inventory,group_vars,playbooks,roles,report<span class="o">}</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="nb">cd</span><span class="w"> </span>~/cm5-cluster
</span></code></pre></div>
<h2 id="inventory-first-time-ssh-setup">Inventory &amp; First-Time SSH Setup</h2>
<ul>
<li>Create <code>inventory/hosts.yml</code>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nt">all</span><span class="p">:</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">  </span><span class="nt">children</span><span class="p">:</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="nt">cm5_cluster</span><span class="p">:</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">        </span><span class="nt">CM501</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.10.11</span><span class="p p-Indicator">}</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">        </span><span class="nt">CM502</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.10.12</span><span class="p p-Indicator">}</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">        </span><span class="nt">CM503</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.10.13</span><span class="p p-Indicator">}</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">        </span><span class="nt">CM504</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.10.14</span><span class="p p-Indicator">}</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">      </span><span class="nt">vars</span><span class="p">:</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">        </span><span class="nt">ansible_user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pi</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">        </span><span class="nt">ansible_ssh_pass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">raspberry</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">        </span><span class="nt">ansible_ssh_common_args</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;-o</span><span class="nv"> </span><span class="s">StrictHostKeyChecking=no&#39;</span>
</span></code></pre></div>
Generate &amp; push SSH key (password login is kept):</li>
</ul>
<h3 id="create-playbooksinit-sshyml-file">Create playbooks/init-ssh.yml file</h3>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nn">---</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm5_cluster</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Push public key</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">      </span><span class="nt">authorized_key</span><span class="p">:</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pi</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;file&#39;,</span><span class="nv"> </span><span class="s">&#39;~/.ssh/id_ed25519.pub&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span></code></pre></div>
<h3 id="run-once">Run once:</h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-f<span class="w"> </span>~/.ssh/id_ed25519<span class="w"> </span>-N<span class="w"> </span><span class="s1">&#39;&#39;</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>ansible-galaxy<span class="w"> </span>collection<span class="w"> </span>install<span class="w"> </span>ansible.posix<span class="w">   </span><span class="c1"># only if using FQCN</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory/hosts.yaml<span class="w"> </span>playbooks/init-ssh.yml
</span></code></pre></div>
<h3 id="basic-system-initialization">Basic System Initialization</h3>
<ul>
<li>playbooks/site.yml</li>
</ul>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nn">---</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Initialize all CM5 nodes</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm5_cluster</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">common</span>
</span></code></pre></div>
<h3 id="create-rolescommontasksmainyml">Create <code>roles/common/tasks/main.yml</code></h3>
<p><div class="language-yaml highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nn">---</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Expand root filesystem</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">  </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">raspi-config --expand-rootfs</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reboot</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set unique hostname</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">  </span><span class="nt">hostname</span><span class="p">:</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Update system</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">  </span><span class="nt">apt</span><span class="p">:</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="nt">update_cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="nt">upgrade</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dist</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install common packages</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">  </span><span class="nt">apt</span><span class="p">:</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3-venv</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3-dev</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build-essential</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">htop</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vim</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="nt">handlers</span><span class="p">:</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reboot</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">    </span><span class="nt">reboot</span><span class="p">:</span>
</span></code></pre></div>
* Execute:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory/hosts.yaml<span class="w"> </span>playbooks/site.yml
</span></code></pre></div></p>
<h2 id="create-python-virtualenv-install-data-science-packages">Create Python Virtualenv &amp; Install Data-Science Packages</h2>
<ul>
<li>create <code>playbooks/venv.yml</code>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nn">---</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy Python venv with AI/ML packages</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm5_cluster</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="nt">venv_path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/home/{{</span><span class="nv"> </span><span class="s">ansible_user</span><span class="nv"> </span><span class="s">}}/venv&quot;</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="nt">python_packages</span><span class="p">:</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pandas</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numpy</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">opencv-python</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matplotlib</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">seaborn</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xgboost</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pillow</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">onnxruntime</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ensure venv directory exists</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">      </span><span class="nt">file</span><span class="p">:</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">venv_path</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">directory</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">        </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ansible_user</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">        </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ansible_user</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create virtualenv</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3 -m venv {{ venv_path }}</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="w">      </span><span class="nt">args</span><span class="p">:</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="w">        </span><span class="nt">creates</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">venv_path</span><span class="nv"> </span><span class="s">}}/bin/activate&quot;</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upgrade pip</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="w">      </span><span class="nt">pip</span><span class="p">:</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="w">        </span><span class="nt">executable</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">venv_path</span><span class="nv"> </span><span class="s">}}/bin/pip&quot;</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install packages</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a><span class="w">      </span><span class="nt">pip</span><span class="p">:</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a><span class="w">        </span><span class="nt">executable</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">venv_path</span><span class="nv"> </span><span class="s">}}/bin/pip&quot;</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">python_packages</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Auto-activate venv on login</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/profile.d/venv.sh</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a><span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;0644&#39;</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a><span class="w">        </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a><span class="w">          </span><span class="no">[ -d &quot;{{ venv_path }}&quot; ] &amp;&amp; source {{ venv_path }}/bin/activate</span>
</span></code></pre></div></li>
<li>Execute:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory/hosts.yaml<span class="w"> </span>playbooks/venv.yml
</span></code></pre></div></li>
</ul>
<h2 id="gather-hostname-ip-disk-information">Gather Hostname, IP, Disk Information</h2>
<ul>
<li>Create <code>playbooks/gather-host-info.yml</code>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nn">---</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Collect hostname, IPs, disk usage</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm5_cluster</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="nt">report_dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">playbook_dir</span><span class="nv"> </span><span class="s">}}/../report&quot;</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ensure report directory exists (locally)</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">      </span><span class="nt">file</span><span class="p">:</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">report_dir</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">directory</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">      </span><span class="nt">delegate_to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">      </span><span class="nt">run_once</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Render per-host JSON file</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">      </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host-info.json.j2</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">report_dir</span><span class="nv"> </span><span class="s">}}/{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}.json&quot;</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">      </span><span class="nt">delegate_to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
</span></code></pre></div></li>
<li>Create playbooks/templates/host-info.json.j2
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>{% set root = ansible_mounts | selectattr(&#39;mount&#39;,&#39;equalto&#39;,&#39;/&#39;) | first %}
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>{&quot;hostname&quot;:&quot;{{ ansible_hostname }}&quot;,&quot;ipv4&quot;:{{ ansible_all_ipv4_addresses | to_json }},&quot;disk_GB&quot;:&quot;{{ (root.block_total * root.block_size / 1024**3) | round(2) }}&quot;,&quot;used_GB&quot;:&quot;{{ (root.block_used * root.block_size / 1024**3) | round(2) }}&quot;,&quot;usage&quot;:&quot;{{ (root.block_used / root.block_total * 100) | round(1) }}%&quot;}
</span></code></pre></div></li>
<li>Run &amp; view:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>jq
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory/hosts.yaml<span class="w"> </span>playbooks/gather-host-info.yml
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>cat<span class="w"> </span>report/*.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-s<span class="w"> </span>.
</span></code></pre></div></li>
</ul>
<h2 id="batch-shutdown-reboot">Batch Shutdown / Reboot</h2>
<ul>
<li>Create <code>playbooks/shutdown.yml</code>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nn">---</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Shutdown all CM5 nodes</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm5_cluster</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Power off</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shutdown -h now</span>
</span></code></pre></div></li>
<li>Create <code>playbooks/reboot.yml</code>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nn">---</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Reboot all CM5 nodes</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cm5_cluster</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Reboot</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reboot</span><span class="w"> </span>
</span></code></pre></div></li>
<li>Execute: 
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory/hosts.yaml<span class="w"> </span>playbooks/shutdown.yml<span class="w">   </span><span class="c1"># shutdown</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory/hosts.yaml<span class="w"> </span>playbooks/reboot.yml<span class="w">    </span><span class="c1"># reboot  </span>
</span></code></pre></div></li>
</ul>
<h3 id="get-the-cpu-temperature">Get the CPU temperature</h3>
<ul>
<li>Create a file structure like this:</li>
</ul>
<pre>
cpu_temp/
├── hosts.ini          # Inventory file – list of managed hosts
├── cpu_temp.yml       # Main Ansible playbook
└── templates/
    └── temp_report.j2 # Optional Jinja2 template for formatted output
</pre>

<ul>
<li>Explanations:</li>
</ul>
<table>
<thead>
<tr>
<th>Directory / File</th>
<th>Purpose &amp; Explanation (English)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cpu_temp/</code></td>
<td>Root directory that contains all playbook-related files.</td>
</tr>
<tr>
<td><code>hosts.ini</code></td>
<td>Inventory file listing the managed hosts (the Raspberry Pi nodes).</td>
</tr>
<tr>
<td><code>cpu_temp.yml</code></td>
<td>Main Ansible playbook that defines the tasks to retrieve and process CPU temperatures.</td>
</tr>
<tr>
<td><code>templates/</code></td>
<td>Directory for Jinja2 templates used to create formatted reports or files.</td>
</tr>
<tr>
<td><code>templates/temp_report.j2</code></td>
<td>Optional Jinja2 template for generating a nicely-formatted output report.</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>Create <code>playbooks/cpu_temp.yml</code>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># This playbook retrieves the CPU temperature of managed Raspberry Pi hosts.</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="c1"># The `vcgencmd measure_temp` command is executed on each host to get the real-time temperature.</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retrieve CPU temperature from managed Raspberry Pi hosts</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rpi</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span><span class="w">        </span><span class="c1"># Skip full fact gathering to speed up execution</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span><span class="w">              </span><span class="c1"># vcgencmd can be run by the pi user without sudo</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Execute vcgencmd measure_temp to obtain real-time temperature</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">      </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vcgencmd measure_temp</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">temp_raw</span><span class="w">  </span><span class="c1"># Save command output in the variable temp_raw</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Parse temperature value (remove prefix and unit)</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">      </span><span class="nt">ansible.builtin.set_fact</span><span class="p">:</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">        </span><span class="nt">cpu_temp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">(temp_raw.stdout</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">regex_replace(&#39;temp=&#39;,</span><span class="nv"> </span><span class="s">&#39;&#39;)</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">regex_replace(\&quot;&#39;C\\n\&quot;,</span><span class="nv"> </span><span class="s">&#39;&#39;))</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Display temperature for each host in the console</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w">      </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Host</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">CPU</span><span class="nv"> </span><span class="s">temperature:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">cpu_temp</span><span class="nv"> </span><span class="s">}}°C&quot;</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Append results to a local summary file (optional)</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">      </span><span class="nt">ansible.builtin.lineinfile</span><span class="p">:</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;./cpu_temp_summary.txt&quot;</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="w">        </span><span class="nt">line</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">&#39;%Y-%m-%d</span><span class="nv"> </span><span class="s">%H:%M:%S&#39;</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">strftime</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">cpu_temp</span><span class="nv"> </span><span class="s">}}°C&quot;</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="w">        </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="w">      </span><span class="nt">delegate_to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span><span class="w">  </span><span class="c1"># Run this task on the Ansible control node </span>
</span></code></pre></div></p>
</li>
<li>
<p>Explanations:</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Playbook Segment</th>
<th>Purpose &amp; Explanation (English)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>---</code></td>
<td>YAML file start marker.</td>
</tr>
<tr>
<td><code>- name: 获取树莓派管理主机的 CPU 温度</code></td>
<td>Name of the play; it appears in the playbook output.</td>
</tr>
<tr>
<td><code>hosts: rpi</code></td>
<td>Targets only hosts in the <code>[rpi]</code> group from the inventory.</td>
</tr>
<tr>
<td><code>gather_facts: no</code></td>
<td>Skips the <code>setup</code> module to reduce SSH round-trips and speed up execution.</td>
</tr>
<tr>
<td><code>become: no</code></td>
<td>Does not escalate privileges; <code>vcgencmd</code> does not require root.</td>
</tr>
<tr>
<td><code>ansible.builtin.command: vcgencmd measure_temp</code></td>
<td>Executes the temperature-retrieval command on the remote host.</td>
</tr>
<tr>
<td><code>register: temp_raw</code></td>
<td>Captures stdout, stderr, and return code of the command into the variable <code>temp_raw</code>.</td>
</tr>
<tr>
<td><code>set_fact: cpu_temp: ...</code></td>
<td>Uses regex to strip prefixes like <code>temp=</code> and the trailing <code>'C</code>, leaving only the numeric value (e.g., <code>47.2</code>).</td>
</tr>
<tr>
<td><code>debug: msg: "主机 ..."</code></td>
<td>Prints the formatted temperature for each host in real time on the console.</td>
</tr>
<tr>
<td><code>lineinfile: ...</code></td>
<td>Appends results to <code>cpu_temp_summary.txt</code> on the control node for later review or graphing.</td>
</tr>
<tr>
<td><code>delegate_to: localhost</code></td>
<td>Ensures the file-append task runs on the Ansible control node, not on the managed hosts.</td>
</tr>
</tbody>
</table>
<ul>
<li>Execute:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nb">cd</span><span class="w"> </span>cpu_temp
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>hosts.ini<span class="w"> </span>cpu_temp.yml
</span></code></pre></div></li>
</ul>
<h2 id="quick-reference">Quick Reference</h2>
<table>
<thead>
<tr>
<th>Action</th>
<th>Command</th>
</tr>
</thead>
<tbody>
<tr>
<td>Check connectivity</td>
<td><code>ansible cm5_cluster -i inventory/hosts.yaml -m ping</code></td>
</tr>
<tr>
<td>Ad-hoc shell</td>
<td><code>ansible cm5_cluster -a "uname -a"</code></td>
</tr>
<tr>
<td>View JSON report</td>
<td><code>cat ~/cm5-cluster/report/*.json \| jq -s .</code></td>
</tr>
</tbody>
</table>
<p>Enjoy your fully-automated CM5 cluster!</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../picomate/" class="btn btn-neutral float-left" title="DeskPi PicoMate"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../super6c/" class="btn btn-neutral float-right" title="DeskPi Super6C">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../picomate/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../super6c/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
